const { Client, GatewayIntentBits, ButtonBuilder, ActionRowBuilder, ButtonStyle } = require('discord.js');
const { google } = require('googleapis');
const path = require('path');
const fs = require('fs');

// Проверка наличия файла
const keyFilePath = path.join(__dirname, 'silent-vent-458121-c6-ad325a0d972a.json');
if (!fs.existsSync(keyFilePath)) {
  console.error('Файл с ключом не найден:', keyFilePath);
  process.exit(1); // Завершение программы с ошибкой
}

// Настройка аутентификации
const auth = new google.auth.GoogleAuth({
  keyFile: keyFilePath,
  scopes: ['https://www.googleapis.com/auth/spreadsheets'],
});

const sheets = google.sheets('v4'); // Инициализация Google Sheets API

const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] });

// Приветствие пользователя при запуске бота
client.once('ready', () => {
  console.log(`Logged in as ${client.user.tag}!`);
});

// Создание кнопки "Получить информацию"
const button = new ButtonBuilder()
  .setCustomId('get_user_info')
  .setLabel('Получить информацию')
  .setStyle(ButtonStyle.Primary);

const row = new ActionRowBuilder().addComponents(button);

// Пример обработки сообщений
client.on('messageCreate', async (message) => {
  if (message.content === '!start') {
    await message.channel.send({ content: 'Привет! Нажмите кнопку ниже, чтобы получить информацию.', components: [row] });
  }
});

// Обработчик нажатий на кнопки
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isButton()) return; // Игнорируем все, кроме кнопок

  if (interaction.customId === 'get_user_info') {
    const userId = interaction.user.id; // Получаем ID пользователя, который нажал на кнопку

    try {
      const sheetsClient = await auth.getClient();
      const spreadsheetId = '1m4sanQR_jJTTw7uIgQmJocaZ4dP1Iw6pWFbYbTYHbfo'; // ID вашей таблицы
      const range = 'w!A:C'; // Убедитесь, что это имя вашего листа

      const response = await sheets.spreadsheets.values.get({
        auth: sheetsClient,
        spreadsheetId,
        range,
      });

      const rows = response.data.values;
      console.log('Полученные строки:', rows); // Логируем полученные данные

      if (rows && rows.length) {
        // Ищем информацию о пользователе по ID
        const userInfo = rows.find(row => row[3] === userId); // Предполагаем, что ID пользователя в четвертом столбце (D)

        if (userInfo) {
          const messageContent = userInfo[0]; // Сообщение
          const author = userInfo[1]; // Автор
          const imageUrl = userInfo[2]; // Ссылка на изображение

          const responseMessage = `
**Message:** ${messageContent}
**Author:** ${author}
**Image:** ${imageUrl}
          `;

          await interaction.reply({ content: responseMessage, ephemeral: true });
        } else {
          await interaction.reply({ content: 'Пользователь не найден.', ephemeral: true });
        }
      } else {
        await interaction.reply({ content: 'Нет данных в таблице.', ephemeral: true });
      }
    } catch (error) {
      console.error('Ошибка при получении данных:', error);
      await interaction.reply({ content: 'Произошла ошибка при получении данных.', ephemeral: true });
    }
  }
});

// Вход в Discord
client.login('MTE5MTQwMTEzMTM4MTg5NTI4OA.G7nUNw.kR_u35ojyCMMZfIFXQeyo7hi8V6ATWNShu3MX0'); // Замените на ваш токен бота
